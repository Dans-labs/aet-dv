name: Build and Deploy App

on:
  workflow_dispatch:
    inputs:
      app:
        description: "App name to build (e.g., ssh, eosc)"
        required: true
        default: "ssh"

jobs:
  build-and-deploy:
    runs-on: self-hosted
    environment: demo

    env:
      NODE_ENV: production
      APP_NAME: ${{ github.event.inputs.app }}
      VITE_CONFIG_NAME: ${{ vars.VITE_CONFIG_NAME }}
      VITE_ENV_NAME: ${{ vars.VITE_ENV_NAME }}
      VITE_PACKAGING_TARGET: ${{ vars.VITE_PACKAGING_TARGET }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 10.3.0   # match your local
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Write environment file
        run: |
          APP_DIR="apps/${APP_NAME}"
          echo "VITE_CONFIG_NAME=${VITE_CONFIG_NAME}" > "$APP_DIR/.env.production"
          echo "VITE_ENV_NAME=${VITE_ENV_NAME}" >> "$APP_DIR/.env.production"
          echo "VITE_PACKAGING_TARGET=${VITE_PACKAGING_TARGET}" >> "$APP_DIR/.env.production"
          echo "Created env file at $APP_DIR/.env.production:"
          cat "$APP_DIR/.env.production"

      - name: Build app
        run: pnpm build:${{ env.APP_NAME }}

      - name: Clean up environment file
        run: |
          APP_DIR="apps/${APP_NAME}"
          rm -f "$APP_DIR/.env.production"
          echo "Removed $APP_DIR/.env.production"

      - name: Deploy app to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "apps/${{ env.APP_NAME }}/dist/assets/*"
          target: "/var/www/html/custom/${{ env.APP_NAME }}/"
          strip_components: 4
          rm: true

      - name: Update footer HTML on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            FOOTER_FILE="/etc/opt/dans.knaw.nl/dataverse-branding/custom-footer.html"
            TARGET_DIR="/var/www/html/custom/${APP_NAME}"
      
            # remove old JS references for this app
            sed -i "/custom\/${APP_NAME}\/.*\.js/d" "$FOOTER_FILE"
      
            # loop over all JS files in TARGET_DIR
            for JS_FILE in "$TARGET_DIR"/*.js; do
              BASENAME=$(basename "$JS_FILE")
              JS_PATH="/custom/${APP_NAME}/$BASENAME"
      
              if grep -q "</body>" "$FOOTER_FILE"; then
                sed -i "/<\/body>/i <script src=\"$JS_PATH\"></script>" "$FOOTER_FILE"
              else
                echo "<script src=\"$JS_PATH\"></script>" >> "$FOOTER_FILE"
              fi
            done
      
            echo "Injected JS files into footer:"
            ls -1 "$TARGET_DIR"/*.js
