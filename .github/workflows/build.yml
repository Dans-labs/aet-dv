name: Build and Deploy App
on:
  workflow_dispatch:
    inputs:
      app:
        description: "App name to build (e.g., ssh, eosc)"
        required: true
        default: "ssh"
jobs:
  build-and-deploy:
    runs-on: self-hosted
    environment: demo
    env:
      NODE_ENV: production
      APP_NAME: ${{ github.event.inputs.app }}
      VITE_CONFIG_NAME: ${{ vars.VITE_CONFIG_NAME }}
      VITE_ENV_NAME: ${{ vars.VITE_ENV_NAME }}
      VITE_PACKAGING_TARGET: ${{ vars.VITE_PACKAGING_TARGET }}
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 10.3.0   # match your local
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Write environment file
        run: |
          APP_DIR="apps/${APP_NAME}"
          echo "VITE_CONFIG_NAME=${VITE_CONFIG_NAME}" > "$APP_DIR/.env.production"
          echo "VITE_ENV_NAME=${VITE_ENV_NAME}" >> "$APP_DIR/.env.production"
          echo "VITE_PACKAGING_TARGET=${VITE_PACKAGING_TARGET}" >> "$APP_DIR/.env.production"
          echo "Created env file at $APP_DIR/.env.production:"
          cat "$APP_DIR/.env.production"
      - name: Build app
        run: pnpm build:${{ env.APP_NAME }}
      - name: Deploy app to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "apps/${{ env.APP_NAME }}/dist/assets/*"
          target: "/var/www/html/custom/${{ env.APP_NAME }}/"
          strip_components: 4
          rm: true
      - name: Update footer HTML on server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: APP_NAME
          script: |
            FOOTER_FILE="/etc/opt/dans.knaw.nl/dataverse-branding/custom-footer.html"
            TARGET_DIR="/var/www/html/custom/${APP_NAME}"
      
            # remove old JS references for this app between the comment markers
            sed -i "/<!-- Advanced Editing Toolkit -->/,/<!-- END Advanced Editing Toolkit -->/{ /custom\/${APP_NAME}\/.*\.js/d; }" "$FOOTER_FILE"
      
            # find the index-*.js file
            INDEX_FILE=$(ls "$TARGET_DIR"/index-*.js 2>/dev/null | head -n 1)
            
            if [ -z "$INDEX_FILE" ]; then
              echo "Error: No index-*.js file found in $TARGET_DIR"
              exit 1
            fi
            
            BASENAME=$(basename "$INDEX_FILE")
            JS_PATH="/custom/${APP_NAME}/$BASENAME"
            SCRIPT_TAGS="  <script type=\"module\" src=\"$JS_PATH\"></script>\n"
      
            # insert scripts within the comment block, before </body> or at the end
            if grep -q "<!-- END Advanced Editing Toolkit -->" "$FOOTER_FILE"; then
              # markers exist, insert before END marker
              sed -i "/<!-- END Advanced Editing Toolkit -->/i ${SCRIPT_TAGS}" "$FOOTER_FILE"
            elif grep -q "</body>" "$FOOTER_FILE"; then
              # no markers but </body> exists, create block before </body>
              sed -i "/<\/body>/i <!-- Advanced Editing Toolkit -->\n${SCRIPT_TAGS}<!-- END Advanced Editing Toolkit -->" "$FOOTER_FILE"
            else
              # no markers and no </body>, append at end
              echo -e "<!-- Advanced Editing Toolkit -->\n${SCRIPT_TAGS}<!-- END Advanced Editing Toolkit -->" >> "$FOOTER_FILE"
            fi
      
            echo "Injected JS files into footer:"
            ls -1 "$TARGET_DIR"/*.js
